---
title: "app_RMarkdowm"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

First off we need to set the working directory. This will allow the main code to retrieve files and functions within the directory. 
```{r}
setwd("~/Text-Mining-with-R/Text_mining_project")
```

Next step is to have all functionning libraries installed and ready to go.Tthis is what we have done in the code chunk below.
```{r, echo=FALSE}
loadPackage <- dget("Source/loadPackage.R")
loadPackage("shiny","topicmodels","dplyr","data.table","easyPubMed","XML","quanteda","tm","foreach","doParallel")
```

In the following section, the main dataframe "df" which contains all the information about each document (Abstract, Authors, Title, et.) is imported as well as the data files generated by the main code. These files are the LSA and the LDA outputs on which we will perform the query process in order to find the abstracts positions. 
```{r}
df <- readRDS("Data/Dataframe")             # raw data

irlba <- readRDS("Data/irlba")              # SVD matrix (for LSA)
ap_documents <- readRDS("Data/LDAdoc")      # for LDA
ap_top_terms <- readRDS("Data/LDAtop_terms")
# ap_lda <- readRDS("Data/LDAtop_terms")
# ap_topics <- readRDS("Data/ap_topics.rds")
```

this next chunk of code is a css section that is used to set the output messages styles. (can be moved to an independant file)
```{r}
## CSS
mycss <- "
#error{color: #F5A52A;
  font-size: 13px;
}
#loadmessage {
   position: relative;
   border-radius: 25px;
   margin-left: auto; 
   margin-right: auto;
   top: 0px;
   left: 0px;
   width: 50%;
   padding: 5px 0px 5px 0px;
   text-align: center;
   font-weight: bold;
   font-size: 100%;
   color: #000000;
   background-color: #F5F5F5;
   z-index: 105;
}
#pubmed_img{
   position: relative;
   top: -54px;
   left: 115px;
}
"
```


This "String" element was created in order to regroup all output strings for easy acces and in prevision for the implementation of difrent languages for the app.
```{r}
Strings <- data.frame(  "noPosQuery" = "Your positive querry isn't significant in any of our topics, try an other research"
                      , "noNegQuery" = "Sorry, we will not take into account the negative request"
                      , "insignificantNegQuery" = "Your negative querry isn't significant in any of our topics, try an other research or continue")

```


For the following sections, a basic knowledge of the RCRAN:shiny library is needed. Basicaly in order for the shiny app to work properly, it requires two elements: 
- the "ui" or user interface which groups all the interactive widgets and the layout of the app,
- and the "server" which consists of the server logic that defines the behaviour of the app.

In our user interface, we have set the layout to be divided between a sidebar and a main page. The sidebar is where the user enters the query inputs as well as the selected method of search. And on the main page, a list of relevant abstracts and other info will be displayed.
Note that the css file is called in this section.
```{r}

############################## User Interface ##############################
ui <- fluidPage(
  
  titlePanel("Search"),
  img(id="pubmed_img",src = "PubMed.png", height = 52, width = 150),
  tags$head(tags$style(HTML(mycss))),
  
  sidebarLayout(
    
    #side panel ---------------------
    sidebarPanel(width = 3,
      textInput("positive_query","Search:",value = "breast"),
      textInput("negative_query","negative query:",value = ""),
      helpText("It is possible to add a negative querry in order to avoid certain topics"),
      selectInput("method", 
                  label = "Select your search method:",
                  choices = c("LSA", "LDA", "Pubmed query"),
                  selected = "LSA"),
      helpText("LSA: or latent semantic analysis is a method that bla bla"),
      helpText("LDA: or latent dirichlet allocation is a bla bla bla"),
      hr(),
      textOutput("error") # marche que sur LDa pour l'instant
    ),
    
    
    # Main panel --------------------
    mainPanel(
      textOutput("environment"),
      textOutput("show_Results_num"),
      hr(),
      conditionalPanel(condition="$('html').hasClass('shiny-busy')",
                       tags$div("Loading...",id="loadmessage")),
      tableOutput("table")
    )
  )
)
```


We now enter the core of the app: the server logic. Like previously mentionned, here will be defined the behaviour of the app. the server is a type function that accepts the input and output arguments. In this section, we will proceed to the actual query processing, the output will be the list of abstracts of intrest.
Note that the query systems are computed within a "renderPrint({ ... })" environment, this is to enable the app to be aware of changes of the input variables and thus react acordingly.
We start by defining our "Results" variable which is a list that will contain the indices of the abstracts of intrest. Next we call the query function respective to each method.
Depending on the User's choice of method, the query system will be applied either to the irlba martix (for LSA), the ap_top_terms and ap_documents matrices (for the LDA) or the raw "df" dataframe (for PubMedQuery). As you can see we have added the PubMed query system for testing ang comparison purposes but it is not meant to be kept in the final version.
As mentioned before, the query system will return the index of the abstracts of interest winthin de raw dataframe "df" so the next step is to retrieve these abstracts.
Finaly we define a new datatable "DT" that contains all the information regarding the abstracts on interest. This data table will be printed in the main page of the user interface and will display the first 10 documents.
```{r}
############################## Server logic ##############################
server <- function(input, output) {
  
  output$environment <- renderPrint({ 
    
    Result <- 0
    
#################  LSA
    if (input$method == "LSA") {
      query_system <- dget("Source/LSA_query_system.R")
      
      if (sum(which(rownames(irlba$v) == "hepatic")) > 0){
        stemming <- FALSE
      }else{stemming <- TRUE}
      
      Result <- query_system(irlba,input$positive_query,input$negative_query,df$Abstract,stemming)
      # cat(input$positive_query,input$negative_query)
      DT = data.table(
        Title = df$Title[Result[1:10]],
        abstract = df$Abstract[Result[1:10]],
        id = df$ID[Result[1:10]],
        date = df$Date[Result[1:10]],
        author = df$Author[Result[1:10]])

    } # end if LSA
    
    
#################  LDA
    if (input$method == "LDA") {
      
      query_system <- dget("Source/LDA_query_system.R")
      
      Result <- query_system(input$positive_query,input$negative_query,ap_top_terms,ap_documents,df$Abstract)

      DT = data.table(
        Title = df$Title[Result[1:10]],
        abstract = df$Abstract[Result[1:10]],
        id = df$ID[Result[1:10]],
        date = df$Date[Result[1:10]],
        author = df$Author[Result[1:10]])
      
    } # end if LDA
    
    
#################  Pubmed query 
    if (input$method == "Pubmed query") {
      
      query_system <- dget("Source/Extract_Data.R")
      
      abstractSize <- c(100,3000) # min and max caracter in abstracts analysed
      
      df <- query_system(input$positive_query,abstractSize)
      
      DT = data.table(
        Title = df$Title[1:10],
        abstract = df$Abstract[1:10],
        id = df$ID[1:10],
        date = df$Date[1:10],
        author = df$Author[1:10])
      
    } # end Pubmed query
    
```

This last section returns the number of found results and the datatable "DT" outpust that can be handled by the user interface.
```{r}
##### Print output: 
    output$show_Results_num <- renderText({ paste("We found:",length(Result),"results.") })
    output$table <- renderTable(DT)
    
  }) # end Render OK
  
}
```


```{r}
# Run the app --------------------
shinyApp(ui = ui, server = server)
```
